From fe47183ffc513e86615589b02fd83498f54e7ce8 Mon Sep 17 00:00:00 2001
From: mohit <mohit.p@variscite.com>
Date: Thu, 12 May 2022 10:40:34 -0700
Subject: [PATCH 06/11] sepolicy: Add permissions for system_suspend

Change-Id: Ib43030d54c70e021ccbe949b2fd55429b7488ed5
---
 prebuilts/api/31.0/private/coredomain.te     |  1 +
 prebuilts/api/31.0/private/system_suspend.te | 33 ++++++++++++++++++++
 prebuilts/api/31.0/public/domain.te          |  1 +
 private/coredomain.te                        |  1 +
 private/system_suspend.te                    | 33 ++++++++++++++++++++
 public/domain.te                             |  1 +
 6 files changed, 70 insertions(+)

diff --git a/prebuilts/api/31.0/private/coredomain.te b/prebuilts/api/31.0/private/coredomain.te
index ac7843c10..2fa4d19d6 100644
--- a/prebuilts/api/31.0/private/coredomain.te
+++ b/prebuilts/api/31.0/private/coredomain.te
@@ -141,6 +141,7 @@ full_treble_only(`
     -ueventd
     -vold
     -system_server
+    -system_suspend
   } sysfs:file no_rw_file_perms;
 
   # /dev
diff --git a/prebuilts/api/31.0/private/system_suspend.te b/prebuilts/api/31.0/private/system_suspend.te
index caf8955bb..6dbe9ec40 100644
--- a/prebuilts/api/31.0/private/system_suspend.te
+++ b/prebuilts/api/31.0/private/system_suspend.te
@@ -27,6 +27,39 @@ allow system_suspend bluetooth:binder call;
 allow system_suspend dumpstate:fd use;
 allow system_suspend dumpstate:fifo_file write;
 
+allow system_suspend sysfs:dir read;
+allow system_suspend sysfs_batteryinfo:dir read;
+
+allow system_suspend sysfs_suspend_stats:dir read;
+allow system_suspend sysfs_wakeup:dir read;
+
+allow system_suspend sysfs:dir open;
+allow system_suspend sysfs_batteryinfo:dir open;
+
+allow system_suspend sysfs:file read;
+allow system_suspend sysfs_batteryinfo:file read;
+
+allow system_suspend sysfs:file open;
+allow system_suspend sysfs_batteryinfo:file open;
+
+allow system_suspend sysfs:file getattr;
+allow system_suspend sysfs_batteryinfo:file getattr;
+
+allow system_suspend sysfs_net:dir read;
+allow system_suspend sysfs_rtc:dir read;
+
+allow system_suspend sysfs_net:dir open;
+allow system_suspend sysfs_rtc:dir open;
+
+allow system_suspend sysfs_net:file read;
+allow system_suspend sysfs_rtc:file read;
+
+allow system_suspend sysfs_net:file open;
+allow system_suspend sysfs_rtc:file open;
+
+allow system_suspend sysfs_net:file getattr;
+allow system_suspend sysfs_rtc:file getattr;
+
 neverallow {
     domain
     -atrace # tracing
diff --git a/prebuilts/api/31.0/public/domain.te b/prebuilts/api/31.0/public/domain.te
index 68e6f7a78..b4a58fc5d 100644
--- a/prebuilts/api/31.0/public/domain.te
+++ b/prebuilts/api/31.0/public/domain.te
@@ -1375,6 +1375,7 @@ full_treble_only(`
     -charger
     # TODO(b/110891300): remove this exception
     -incidentd
+    -system_suspend_server
   } sysfs_batteryinfo:file { open read };
 ')
 
diff --git a/private/coredomain.te b/private/coredomain.te
index ac7843c10..2fa4d19d6 100644
--- a/private/coredomain.te
+++ b/private/coredomain.te
@@ -141,6 +141,7 @@ full_treble_only(`
     -ueventd
     -vold
     -system_server
+    -system_suspend
   } sysfs:file no_rw_file_perms;
 
   # /dev
diff --git a/private/system_suspend.te b/private/system_suspend.te
index caf8955bb..6dbe9ec40 100644
--- a/private/system_suspend.te
+++ b/private/system_suspend.te
@@ -27,6 +27,39 @@ allow system_suspend bluetooth:binder call;
 allow system_suspend dumpstate:fd use;
 allow system_suspend dumpstate:fifo_file write;
 
+allow system_suspend sysfs:dir read;
+allow system_suspend sysfs_batteryinfo:dir read;
+
+allow system_suspend sysfs_suspend_stats:dir read;
+allow system_suspend sysfs_wakeup:dir read;
+
+allow system_suspend sysfs:dir open;
+allow system_suspend sysfs_batteryinfo:dir open;
+
+allow system_suspend sysfs:file read;
+allow system_suspend sysfs_batteryinfo:file read;
+
+allow system_suspend sysfs:file open;
+allow system_suspend sysfs_batteryinfo:file open;
+
+allow system_suspend sysfs:file getattr;
+allow system_suspend sysfs_batteryinfo:file getattr;
+
+allow system_suspend sysfs_net:dir read;
+allow system_suspend sysfs_rtc:dir read;
+
+allow system_suspend sysfs_net:dir open;
+allow system_suspend sysfs_rtc:dir open;
+
+allow system_suspend sysfs_net:file read;
+allow system_suspend sysfs_rtc:file read;
+
+allow system_suspend sysfs_net:file open;
+allow system_suspend sysfs_rtc:file open;
+
+allow system_suspend sysfs_net:file getattr;
+allow system_suspend sysfs_rtc:file getattr;
+
 neverallow {
     domain
     -atrace # tracing
diff --git a/public/domain.te b/public/domain.te
index 68e6f7a78..b4a58fc5d 100644
--- a/public/domain.te
+++ b/public/domain.te
@@ -1375,6 +1375,7 @@ full_treble_only(`
     -charger
     # TODO(b/110891300): remove this exception
     -incidentd
+    -system_suspend_server
   } sysfs_batteryinfo:file { open read };
 ')
 
-- 
2.25.1

